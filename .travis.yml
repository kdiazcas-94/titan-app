sudo: required
services:
- docker
dist: trusty
language: node_js
node_js:
- '9'
stages:
- name: Tests
- name: Deploy Staging
  if: type = pull_request
- name: Deploy Production
  if: branch = master AND type != pull_request
- name: Build Docker Image
  if: branch = master AND type = cron
before_install:
- docker pull unkso/titan-image
jobs:
  include:
  - stage: Tests
    script: docker run -v $(pwd):/app unkso/titan-image /bin/bash -c "cd titan-web-client
      && yarn && yarn test"
  - stage: Tests
    script: docker run -v $(pwd):/app unkso/titan-image /bin/bash -c "cd titan-server
      && cargo test"
  - stage: Build Docker Image
    script: scripts/build-and-push-docker-image.sh
env:
  global:
  - secure: JNy2ccgjDBwl+2oo/QTVCziDufx7WATI9lpHwWxvI6JYlqRy9TW23fOr6/9SwgYJYOd59h+XI9LQ7c5t4B1JQ5UFWWJQB1fxbK5OMtK+78WVFaYjXfQwXYFCMWATnP8PR8xsWUdGcvaMdjXfgxAcS2ctK6saSsNRMX/YhF+2QkKodqD1g7H/1MiYO8lLHVQ4BVPwhnnwRQM8yoBBd5nUFIssbJ6Ouqij/W2cdTXKdEH2Z2CP/NCISrVREHaxWNZwZI1oov59N6VbW0lb/6qVbWFbzrubgdj1SWAMIW4W207oh4+mXRFsrQkRgznxMyDcq9oYgRkLPj26omZS0G4ffaZXkowv6p9A/nrWkMeUNeJntX8P0j5z+GSz1bzfuhq3LqGbWHFezymoKUW5Lvq63YgOSmHqN7hp78gRr5lJQlDTfjBjRNgeTZB4OarYWAHI5rpT68mHuyj3e9AB9oLpaIU6YedXD97LUokPQHJzs+MuvMXDqyzHGksSsOlNF1a9RTJPVmlxYv/oyGpWpwE2VSjQNKYnd8jmnmN2Ah61GZ+sh0/ZUaznf2PW5GCn/3eoQr5scEZLW67c/hKhQ7bDaeMqkFJyGOG94+c99ZW41w9IJ6cMJdKIhd3ae6TfthB1rwerSxODqEsivO8SBemffTHl9iQ4jZqFVqRSCMDjQHs=
  - secure: cpkpOjgHG55oo/G+aTJJSSd/jCGmhen1NC5dKo87VTuP15RYIfwHV4TTd+2uZAqj+Qb/5qGSDU4ZO+k9eP3/pSpHS0klyoCvr850BQXwLDbKSPjlTvnl6wuAyQRbGr7mmSDbJfkKFvaRUObMockhYmdYDCHjp/ZCUY95XWAn7dALFi2WDEP/MLTkSBkZcAphk9anoJl03vUlEtlxZPeL2RIwyhoEO0KKNK6inocWmv4DCc97g2yjPt3GR5QS9XFnVEIXecDgfQNqYe/JVn0tM5lDNNiFkkdOwwEVsUhg8FcTG5zNhzNjJskQX0FAkCs1AcPchGxxQUpE6FD9ti+sU4vRoZlFcXouFj8QNeoxz8/u9U0Dzq4CQrPKJNHzv8aWUpQMk+WCSxDkeX+L3x4/Ty/zywYxlnCTM6pvyZft3Enrma2AscBCaTDZ0uiyqpVbO5OCwso3l5GN2G+J6+lsk/feUQJPlcV0toDazymtX2Unv8FEYo8ag8sJoqY+/kGKwEXwPWo8hMdXOSPD/0GbEFzQ0LxprLNOBuS5s+C1fgMK6QzmHHEQ36KldGCLyo9WJuoER/y8tncYJy1JHTpf059d4Cc06bWMsKx9EsNYjmTKpGJ19bBzfi4h21nTsPEvO9EAOhenWDbhKRALhK3uWB5yYwL5b1U3KiVEtj6HTak=
  - secure: Y2w6C3z39IEFW2A2mig354ANK/XA5faA80dvxRvkpb+EWDu5rZPpyIrGI7mZpVdD7pCb7vYkRxnjEeY5CRCxpXlr1WzCuPcdWqVYXyPc2CXaB9BkqloQdOOObXkSSzBIpc0q//guFXNeK1XxBe0Fyyfpd/C3xFg1nbNSGmH3Twish68BUBtYhrvv+lCTiFibAw+DWoN38e/mxD5emN3kT0hEtRBUxrYaBjtBi8VqIWrdN5pTk+h/pVvIp8iRed5Jk5yyTHe8SyDhMPlxIGivj5M4MQEKwKqu24styyYHXujV0X75FLNbqqXsomivnBz34dFBKGL/3WklV9IoDsrqzWoIqQP+tahiSZIlehG0uycCcgXVqJ9uCZiV3xv67EF6QGEelDEHI4B5OodxflliyOAAnByMPjJJByEq2Updqw3KQCN0T47w/sAi4LBOEHIHdGJoQM3FrEE+j4FJJMWMyxit7GkmQRwDP+DsZt6cGidMc53eW/7n9HLDH9o4a4TLYn020clmUHRMcv5q08jfmiULxSwEelB/ZBK0YwXtB30S9xgRninVtxhLMACjZWzObGLOuGic+u93hkVzla2TIwwYOtIkuspm2hfW3rr6WbFKgLY0bDFzusJckIY8w6SxkLvp13yrWmwQCv57oQuvK8VRpUVU4Bs4zBefcFhmI3s=
  - secure: J65OWAjdL7bQroXYYIOgWS7wONDDVUKVX8Qegq9eXB9HTbvLAcSqox85K1h2woP1xacZz5ICYtp7cVrevRBsDidydlSpefcA+b8t/Y43qzdTCR/kedrvhl6jcQcRf69u0a/kZAdF44/SsdzOjvu2EoJeWVAWWDittDsfTgvhfL/XACIsV5785xu7Tq71AQnCjzEAeX4efHFqKxqWT117zTBcG4R2Rh1DWBZCgK3YTepF+cJR2T5pZHLKEbsb9R0wqlVIndbIlKeQrPbuZAAnq//H+wxo17ukV/MFgMTkiBoe0P02Zh6pMdlMALAKZPRlMLUahWm7Q8+CsOAvty+cSUHVi0QLl/3N2L1wSM3BiGCptlAaFYJNCEKw34cPp2dKyW3tb6sLfj0QXj5i7B2HzobwdjXhsYjZE3fGPt7uH60cG8blmgbtroUVc4897/uDDBKU9zTcORRThd74qiKOIjGYdOK+O3535Jgh/BlYYOP7dXu9k3BvSQ46ybLalejHExNhjOmvi/InqjCjmhWwGosuh659y+nIUQsWs8ri5oAm477KBMUAZhDxZpp/KQIb/xtwA506BpRZA0Kj/ney7A+lqUeLQ1cZnsVtnNoo09ByA/NbVBD9PDXyFnPZTscPmponC7VdeY4WFxz1E2wPkH/lnDjYOO1qOD6Eezxa6PY=
